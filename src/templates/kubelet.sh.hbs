#!/usr/bin/env bash
set -Eeuo pipefail
exec >&2

{{#if debug}}
# =============================================================================
# DEBUG MODE ENABLED
# =============================================================================
# Bootstrap Request Information:
#   Timestamp:     {{timestamp}}
#   Component:     {{component}}
#   Version:       {{version}}
#   Machine ID:    {{machineId}}
#   User-Agent:    {{userAgent}}
{{#if machineToken}}
#   Machine Token: [REDACTED] (length: {{length machineToken}})
{{/if}}
# =============================================================================
set -x
{{/if}}

export KUBECONFIG="/var/run/kube/kubeconfig"
export NODE_NAME="$(hostname -s | tr '[:upper:]' '[:lower:]')"  

export KUBELET_FLAGS="\
--config=${KUBELET_CONFIG} \
--kubeconfig=${KUBECONFIG} \
--root-dir=/var/run/kube \
--cert-dir=/var/run/kube/pki \
--hostname-override=${NODE_NAME} \
--cluster-domain=${CLUSTER_DOMAIN} \
--cluster-dns=${CLUSTER_DNS} \
"

export CRI_DOCKERD_FLAGS="\
--container-runtime-endpoint=unix:///var/run/cri-dockerd.sock \
--cri-dockerd-root-directory=/var/run/kube/cri-dockerd \
--network-plugin=cni \
--hairpin-mode=hairpin-veth \
"

cat > /etc/kubernetes/kubelet/{{machineId}}.yaml << 'KUBELET_YAML_EOF'
# Generated at {{timestamp}}
{{{kubeletYaml}}}
KUBELET_YAML_EOF
echo "Kubelet Config: /etc/kubernetes/kubelet/{{machineId}}.yaml" >> infos

ln -sf /etc/kubernetes/kubelet/{{machineId}}.yaml "${KUBELET_CONFIG}"
echo "Kubelet Config Symlink: ${KUBELET_CONFIG}" >> infos

cat > ${KUBECONFIG} << 'KUBECONFIG_YAML_EOF'
# Generated at {{timestamp}}
{{{kubeconfigYaml}}}
KUBECONFIG_YAML_EOF
echo "Kubeconfig: ${KUBECONFIG}" >> infos

export {{env component}}_BOOTSTRAPPED="true"
export {{env component}}_BOOTSTRAPPED_BY="sk8s.net"
export {{env component}}_BOOTSTRAPPED_AT="{{timestamp}}"
